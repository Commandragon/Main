<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta</title>
    <!-- SCRIPT FOR ACCESS CONTROL: Must be at the very top -->
    <script>
        if (window.self === window.top) {
            window.location.replace("https://truth.us.to");
        }
    </script>
    <style>
        :root {
            --background-color: #0b0d12; /* Slightly off-black */
            --primary-color: #00ff5e;
            --bright-color: #a1ffe7;
            --button-background: #000000;
            --button-hover-background: #00ff991a;
            --button-text-color: #fff;
            --font-family: 'Courier New', Courier, monospace;
            --modal-background: #111319;
            --modal-border-color: #333;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--background-color);
            color: var(--primary-color);
            font-family: var(--font-family);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: default;
        }
        
        #welcome-message {
            font-size: 2.5rem;
            color: var(--primary-color);
            text-shadow: 0 0 8px var(--primary-color);
            position: absolute;
            z-index: 20;
            opacity: 0;
            transition: opacity 1.5s ease-out;
            max-width: 90vw;
            text-align: center;
        }
        #welcome-message.visible {
            opacity: 1;
        }
        .cursor {
            display: inline-block;
            width: 1rem;
            height: 2.5rem;
            background: var(--primary-color);
            animation: blink 1s steps(1) infinite;
            vertical-align: bottom;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }

        #main-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            min-height: 50vh;
            opacity: 0;
            visibility: hidden;
            transition: opacity 1.5s ease-in-out;
        }
        #main-ui.visible {
            opacity: 1;
            visibility: visible;
        }

        #buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 15vh;
            position: relative;
            z-index: 10;
        }

        .button {
            background: var(--button-background);
            color: var(--button-text-color);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px 36px;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0;
            transform: translateY(50px);
            transition: background 0.2s, transform 0.5s ease-out, opacity 0.5s ease-out, border-color 0.3s;
        }
        
        .button.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .button:nth-child(1).visible { transition-delay: 0.2s; }
        .button:nth-child(2).visible { transition-delay: 0.4s; }
        .button:nth-child(3).visible { transition-delay: 0.6s; }
        .button:nth-child(4).visible { transition-delay: 0.8s; }

        .button:hover {
            background: var(--button-hover-background);
            border-color: var(--primary-color);
        }
        
        .button-text {
            display: inline-block;
            min-width: 120px;
            text-align: center;
        }

        #weather-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--button-background);
            border: 1px solid var(--modal-border-color);
            border-radius: 8px;
            padding: 15px 20px;
            font-size: 0.9rem;
            z-index: 100;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
            pointer-events: none;
        }
        #weather-popup.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #weather-popup p {
            margin: 4px 0;
            color: var(--button-text-color);
        }
        #weather-popup p:first-child {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0;
            transition: opacity 1.5s ease-in;
        }

        /* --- Settings Button & Modal Styles --- */
        #settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--modal-background);
            border: 1px solid var(--modal-border-color);
            border-radius: 50%;
            color: var(--primary-color);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            /* MODIFIED: Hide by default and add opacity to transition */
            opacity: 0;
            pointer-events: none;
            transition: transform 0.3s, border-color 0.3s, opacity 0.8s ease-in-out;
        }
        /* NEW: Class to make the button visible */
        #settings-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #settings-btn:hover {
            transform: rotate(90deg);
            border-color: var(--primary-color);
        }
        #settings-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
        }
        #settings-modal {
            background: var(--modal-background);
            border: 1px solid var(--modal-border-color);
            border-radius: 8px;
            padding: 25px 35px;
            width: 90%;
            max-width: 400px;
            color: var(--button-text-color);
            position: relative;
        }
        #settings-modal h2 {
            color: var(--primary-color);
            margin-top: 0;
            text-align: center;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .setting-item label {
            font-size: 1.1rem;
        }
        /* Custom styles for controls */
        .setting-item input[type="color"],
        .setting-item select,
        .toggle-switch {
            background: var(--button-background);
            border: 1px solid var(--modal-border-color);
            color: var(--button-text-color);
            border-radius: 5px;
            cursor: pointer;
        }
        .setting-item input[type="color"] { padding: 2px; width: 50px; height: 35px; }
        .setting-item select { padding: 8px; font-family: var(--font-family); }

        /* Custom Toggle Switch */
        .toggle-switch {
            width: 60px;
            height: 34px;
            position: relative;
            display: inline-block;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px; width: 26px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        #close-modal-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            transition: color 0.3s;
        }
        #close-modal-btn:hover { color: var(--primary-color); }


        @media (max-width: 600px) {
            #welcome-message { font-size: 1.8rem; }
            .cursor { height: 1.8rem; }
            #main-ui { min-height: auto; justify-content: center; }
            #buttons { margin-top: 5vh; }
            .button { font-size: 1rem; padding: 12px 18px; }
            .button-text { min-width: 90px; }
            #weather-popup { font-size: 0.8rem; bottom: 10px; right: 10px; padding: 10px 15px; }
            #settings-btn { top: 10px; right: 10px; width: 40px; height: 40px; font-size: 20px; }
        }
    </style>
</head>
<body>
    <audio id="audio-bg" src="https://assets.codepen.io/217233/ambi-drone-1.mp3" loop></audio>
    <audio id="audio-typing" src="https://assets.codepen.io/217233/mech-keyboard-1-click.mp3"></audio>
    <audio id="audio-exit" src="https://assets.codepen.io/217233/power-down-1.mp3"></audio>

    <div id="welcome-message">
        <span id="welcome-text"></span><span class="cursor"></span>
    </div>

    <div id="main-ui">
        <div id="buttons">
            <button class="button" data-url="https://KUGSHIUAGSHNIOUGH.uglisounds.se"><span class="button-text" data-text="Soundboard"></span></button>
            <button class="button" data-url="https://iiillllliiiiillllllililliillililillilllililll.catcher.ru/"><span class="button-text" data-text="Games"></span></button>
            <button class="button" data-fetch-url="https://raw.githubusercontent.com/Commandragon/Website/main/list.json"><span class="button-text" data-text="Games 2"></span></button>
            <button class="button" data-url="/MENUAIUOFHUAFEIHIUFHIDHIHGAIOHGOAIHG/Beta/index.html"><span class="button-text" data-text="FAQ"></span></button>
        </div>
    </div>

    <div id="weather-popup"></div>

    <button id="settings-btn" aria-label="Settings">&#9881;</button>

    <div id="settings-modal-overlay">
        <div id="settings-modal">
            <button id="close-modal-btn" aria-label="Close settings">&times;</button>
            <h2>Settings</h2>
            <div class="setting-item">
                <label for="color-picker">Theme Color</label>
                <input type="color" id="color-picker" value="#00ff99">
            </div>
            <div class="setting-item">
                <label for="font-selector">Font Style</label>
                <select id="font-selector">
                    <option value="'Courier New', Courier, monospace">Courier New</option>
                    <option value="'Lucida Console', Monaco, monospace">Lucida Console</option>
                    <option value="'Consolas', 'monaco', monospace">Consolas</option>
                    <option value="monospace">Default Mono</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="weather-toggle">Show Weather</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="weather-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="skip-anim-toggle">Skip Animations</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="skip-anim-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>


    <canvas id="matrix-canvas"></canvas>
    <canvas id="letter-map-canvas" style="display: none;"></canvas>

    <!-- Cookie consent (Delta page) -->
    <style>
      #cookie-consent { position: fixed; left: 18px; bottom: 18px; width: 340px; max-width: calc(100% - 36px); z-index:99999; display:none; }
      #cookie-consent.visible { display:block; }
      #cookie-consent .cc-box { padding:14px; border-radius:8px; background:#0e0f12; color:#dfffe9; border:1px solid #223; box-shadow:0 10px 30px rgba(0,0,0,0.6); font-family: sans-serif; }
      #cookie-consent h3 { color: var(--primary-color); margin:0 0 6px 0; }
      #cookie-consent .cc-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
      #cookie-consent button { padding:7px 10px; border-radius:6px; border:none; cursor:pointer; }
      .btn-accept { background: var(--primary-color); color:#002; }
      .btn-decline { background: #111; color:#bbb; border:1px solid #222; }
    </style>

    <div id="cookie-consent" aria-live="polite">
      <div class="cc-box" role="dialog" aria-label="Cookie preferences">
        <h3>Cookie & Data Preferences</h3>
        <p style="margin:6px 0 8px 0; font-size:0.95rem;">This is a playful popup. Nothing is transmitted off-device.</p>
        <div>
          <label><input type="checkbox" id="cc-cookies-d" checked> Cookies (UI)</label><br>
          <label><input type="checkbox" id="cc-analytics-d"> Analytics (disabled)</label><br>
          <label><input type="checkbox" id="cc-location-d"> Location (prompt only)</label>
        </div>
        <div class="cc-actions">
          <button class="btn-decline" id="cc-decline-d">Decline</button>
          <button class="btn-accept" id="cc-accept-d">Accept</button>
        </div>
        <div style="font-size:0.8rem;color:#99b;margin-top:6px;">Demo only — saved locally and not shared.</div>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const KATAKANA = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
        const FONT_SIZE = 16;
        let isExiting = false;
        let columns, drops, mapImageData, titleGrid = {};
        
        // --- App Settings State (with defaults) ---
        let appSettings = {
            primaryColor: '#00ff5e',
            fontFamily: "'Courier New', Courier, monospace",
            showWeather: true,
            skipAnimations: false
        };

        // --- DOM ELEMENTS ---
        const welcomeMessageEl = document.getElementById('welcome-message');
        const welcomeTextEl = document.getElementById('welcome-text');
        const mainUiEl = document.getElementById('main-ui');
        const buttons = document.querySelectorAll('#buttons .button');
        const buttonTexts = document.querySelectorAll('.button-text');
        const weatherPopupEl = document.getElementById('weather-popup');
        const audioBg = document.getElementById('audio-bg');
        const audioTyping = document.getElementById('audio-typing');
        const audioExit = document.getElementById('audio-exit');
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        const mapCanvas = document.getElementById('letter-map-canvas');
        const mapCtx = mapCanvas.getContext('2d', { willReadFrequently: true });

        // --- Settings Modal Elements ---
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModalOverlay = document.getElementById('settings-modal-overlay');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const colorPicker = document.getElementById('color-picker');
        const fontSelector = document.getElementById('font-selector');
        const weatherToggle = document.getElementById('weather-toggle');
        const skipAnimToggle = document.getElementById('skip-anim-toggle');

        // --- DYNAMIC CSS VARIABLES (will be updated by JS) ---
        let primaryColor, fontFamily, brightColor;

        // --- HELPER FUNCTIONS ---
        const pause = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const getOrdinalSuffix = (day) => {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return "st";
                case 2: return "nd";
                case 3: return "rd";
                default: return "th";
            }
        };
        const formatDateForAnnouncer = (date) => {
            const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });
            const dayOfMonth = date.getDate();
            const month = date.toLocaleDateString('en-US', { month: 'long' });
            return `${dayOfWeek}, ${month} ${dayOfMonth}${getOrdinalSuffix(dayOfMonth)}`;
        };
        
        // --- Settings Management ---
        function saveSettings() {
            localStorage.setItem('deltaSettings', JSON.stringify(appSettings));
        }

        function applySettings() {
            document.documentElement.style.setProperty('--primary-color', appSettings.primaryColor);
            document.documentElement.style.setProperty('--font-family', appSettings.fontFamily);
            
            primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
            fontFamily = getComputedStyle(document.documentElement).getPropertyValue('--font-family').trim();
            brightColor = hexToRgba(primaryColor, 0.7); 
            
            colorPicker.value = appSettings.primaryColor;
            fontSelector.value = appSettings.fontFamily;
            weatherToggle.checked = appSettings.showWeather;
            skipAnimToggle.checked = appSettings.skipAnimations;

            setupMatrix();
        }

        function loadSettings() {
            const saved = localStorage.getItem('deltaSettings');
            if (saved) {
                // Merge saved settings with defaults to avoid errors if new settings are added
                appSettings = { ...appSettings, ...JSON.parse(saved) };
            }
            applySettings();
        }

        // --- CINEMATIC SEQUENCER ---
        async function startExperience() {
            if (appSettings.skipAnimations) {
                welcomeTextEl.textContent = 'Welcome to Delta.';
                welcomeMessageEl.classList.add('visible');
                welcomeMessageEl.querySelector('.cursor').style.display = 'none';
                showMainUI(true); 
            } else {
                await typeWelcomeMessage();
                await pause(1000);
                welcomeMessageEl.style.opacity = '0';
                await pause(1500);
                showMainUI();
            }
            
            setInterval(drawMatrix, 1000 / 37);
            canvas.style.opacity = '1';
            audioBg.play().catch(e => console.warn("Background audio blocked by browser."));
        }

        async function typeWelcomeMessage() {
            const message = `Welcome to Delta.`;
            welcomeMessageEl.classList.add('visible');
            for (let i = 0; i < message.length; i++) {
                welcomeTextEl.textContent += message[i];
                audioTyping.currentTime = 0;
                audioTyping.play().catch(e => {});
                await pause(90);
            }
            welcomeMessageEl.querySelector('.cursor').style.display = 'none';
        }

        async function showMainUI(instant = false) {
            mainUiEl.classList.add('visible');
            if (instant) {
                 buttons.forEach(btn => {
                     btn.style.transition = 'none';
                     btn.classList.add('visible');
                 });
                 buttonTexts.forEach(el => el.innerText = el.dataset.text);
            } else {
                buttons.forEach(btn => btn.classList.add('visible'));
                await pause(1500);
                const decodePromises = Array.from(buttonTexts).map(el => scramble(el, el.dataset.text));
                await Promise.all(decodePromises);
            }

            // MODIFIED: Reveal settings button now that the intro is complete
            settingsBtn.classList.add('visible');

            if (appSettings.showWeather) {
                displayWeatherInfo();
            }
        }

        async function displayWeatherInfo() {
            const fetchWeather = async (url) => {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 4000);
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error('Weather API response not OK');

                    const data = await response.json();
                    const now = new Date();
                    const location = data.nearest_area[0].areaName[0].value;
                    const weatherDesc = data.current_condition[0].weatherDesc[0].value;
                    const tempF = data.current_condition[0].temp_F;
                    const dateString = formatDateForAnnouncer(now);

                    weatherPopupEl.innerHTML = `
                        <p>[System Status]</p>
                        <p>Location: ${location}</p>
                        <p>Date: ${dateString}</p>
                        <p>Weather: ${weatherDesc}, ${tempF}°F</p>
                    `;
                    weatherPopupEl.classList.add('visible');

                    setTimeout(() => {
                        weatherPopupEl.classList.remove('visible');
                    }, 3000);

                } catch (error) {
                    console.warn("Could not fetch weather data:", error.name === 'AbortError' ? 'Request timed out' : error.message);
                }
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        fetchWeather(`https://wttr.in/${latitude},${longitude}?format=j1`);
                    },
                    (error) => {
                        console.warn("Geolocation failed, falling back to IP.", error.message);
                        fetchWeather('https://wttr.in?format=j1');
                    },
                    { timeout: 5000 }
                );
            } else {
                console.warn("Geolocation not supported, falling back to IP.");
                fetchWeather('https://wttr.in?format=j1');
            }
        }
        
        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 4) {
                r = "0x" + hex[1] + hex[1];
                g = "0x" + hex[2] + hex[2];
                b = "0x" + hex[3] + hex[3];
            } else if (hex.length == 7) {
                r = "0x" + hex[1] + hex[2];
                g = "0x" + hex[3] + hex[4];
                b = "0x" + hex[5] + hex[6];
            }
            return `rgba(${+r},${+g},${+b},${alpha})`;
        }


        // --- EXIT ANIMATION ---
        async function triggerExitAnimation(url) {
            if (isExiting || !url) return;
            isExiting = true;
            
            if (appSettings.skipAnimations) {
                window.location.href = url;
                return;
            }

            fetch(url, { method: 'GET', mode: 'no-cors' }).catch(e => console.warn("Preloading failed:", e));

            weatherPopupEl.classList.remove('visible');
            audioExit.play().catch(e => {});
            let bgVolume = audioBg.volume;
            const fadeAudio = setInterval(() => {
                bgVolume -= 0.1;
                if (bgVolume <= 0) {
                    audioBg.pause();
                    clearInterval(fadeAudio);
                } else {
                    audioBg.volume = bgVolume;
                }
            }, 100);

            const encodePromises = Array.from(buttonTexts).map(el => scramble(el, el.dataset.text, 'encode'));
            buttons.forEach(btn => btn.classList.remove('visible'));

            await Promise.all(encodePromises);
            await pause(150);
            document.body.style.transition = 'opacity 0.5s ease-out';
            document.body.style.opacity = '0';
            await pause(500);
            window.location.href = url;
        }

        // --- SCRAMBLE EFFECT ---
        const scramble = (element, finalText, mode = 'decode') => {
            return new Promise((resolve) => {
                const originalText = element.dataset.text || finalText;
                let iteration = 0;
                const interval = setInterval(() => {
                    if (mode === 'decode') {
                        element.innerHTML = originalText.split("").map((_, index) => {
                            if (index < iteration) return `<span>${finalText[index]}</span>`;
                            const randomChar = KATAKANA[Math.floor(Math.random() * KATAKANA.length)];
                            return `<span style="color: ${primaryColor};">${randomChar}</span>`;
                        }).join("");
                    } else {
                        element.style.color = primaryColor;
                        element.innerText = originalText.split("").map((_, index) => {
                            if (originalText.length - index < iteration / 2) return '';
                            return KATAKANA[Math.floor(Math.random() * KATAKANA.length)];
                        }).join("");
                    }
                    const done = (mode === 'decode' && iteration >= finalText.length) || (mode === 'encode' && iteration >= originalText.length * 2);
                    if (done) {
                        clearInterval(interval);
                        element.innerText = (mode === 'decode') ? finalText : '';
                        element.style.color = '';
                        resolve();
                    }
                    iteration += 1 / 3;
                }, 60);
            });
        };

        // --- MATRIX & EFFECTS ENGINE ---
        function setupMatrix() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            mapCanvas.width = canvas.width;
            mapCanvas.height = canvas.height;
            columns = Math.floor(canvas.width / FONT_SIZE);
            drops = Array.from({ length: columns }, () => Math.random() * canvas.height);
            titleGrid = {};
            mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
            mapCtx.fillStyle = "#fff";
            mapCtx.font = `bold 15vw 'Arial Black', Gadget, sans-serif`;
            mapCtx.textAlign = 'center';
            mapCtx.textBaseline = 'middle';
            mapCtx.fillText("DELTA", mapCanvas.width / 2, canvas.height * 0.4);
            try {
                mapImageData = mapCtx.getImageData(0, 0, mapCanvas.width, mapCanvas.height);
            } catch(e) {
                console.error("Could not get image data from canvas, matrix title effect will be disabled.", e);
            }
        }

        function drawMatrix() {
            ctx.fillStyle = 'rgba(16, 19, 26, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = `${FONT_SIZE}px ${fontFamily}`;
            ctx.shadowColor = brightColor;
            for (const key in titleGrid) {
                const char = titleGrid[key];
                ctx.fillStyle = brightColor;
                ctx.shadowBlur = 15;
                ctx.fillText(char.text, char.x, char.y);
            }
            ctx.shadowBlur = 0;

            for (let i = 0; i < columns; i++) {
                const x = i * FONT_SIZE;
                const y = drops[i] * FONT_SIZE;
                const text = KATAKANA[Math.floor(Math.random() * KATAKANA.length)];
                
                if (mapImageData) {
                    const px = (Math.floor(x) + Math.floor(y) * mapCanvas.width) * 4;
                    const isOnLetter = mapImageData.data?.[px + 3] > 128;
                    if (isOnLetter) {
                        titleGrid[`${i},${Math.floor(drops[i])}`] = { text, x, y };
                    }
                }

                ctx.fillStyle = primaryColor;
                ctx.fillText(text, x, y);

                if (isExiting) {
                    drops[i]--;
                    if (drops[i] * FONT_SIZE < 0) drops[i] = canvas.height / FONT_SIZE;
                } else {
                    if (y > canvas.height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                }
            }
        }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            window.addEventListener('resize', setupMatrix);
            buttons.forEach(button => {
                button.onclick = () => {
                    const url = button.dataset.url;
                    const fetchUrl = button.dataset.fetchUrl;
                    if (url) {
                        triggerExitAnimation(url);
                    } else if (fetchUrl) {
                        fetch(fetchUrl).then(res => res.json()).then(data => {
                            if (data.websiteURL) triggerExitAnimation(data.websiteURL);
                        }).catch(err => console.error("Fetch failed:", err));
                    }
                };
            });
            
            // --- Settings Listeners
            settingsBtn.addEventListener('click', () => {
                settingsModalOverlay.style.display = 'flex';
            });
            closeModalBtn.addEventListener('click', () => {
                settingsModalOverlay.style.display = 'none';
            });
            settingsModalOverlay.addEventListener('click', (e) => {
                if (e.target === settingsModalOverlay) {
                    settingsModalOverlay.style.display = 'none';
                }
            });
            colorPicker.addEventListener('input', (e) => {
                appSettings.primaryColor = e.target.value;
                applySettings(); 
            });
            colorPicker.addEventListener('change', saveSettings);

            fontSelector.addEventListener('change', (e) => {
                appSettings.fontFamily = e.target.value;
                applySettings();
                saveSettings();
            });
            weatherToggle.addEventListener('change', (e) => {
                appSettings.showWeather = e.target.checked;
                saveSettings();
            });
            skipAnimToggle.addEventListener('change', (e) => {
                appSettings.skipAnimations = e.target.checked;
                saveSettings();
            });
        }

        // --- INITIALIZATION ---
        function init() {
            audioBg.volume = 0.2;
            audioTyping.volume = 0.5;
            
            loadSettings(); 
            setupEventListeners();
            setupMatrix();
            startExperience();
        }

        init();
    });
    </script>
</body>
</html>
